<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Home Dashboard</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#131821;
  --text:#e6e9ef;
  --muted:#9aa6b5;
  --accent:#7fa2ff;
  --divider:#1e2530;
  --dim:0;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:18px;
  font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:#000;
  opacity:var(--dim);
  pointer-events:none;
  transition:opacity 1s linear;
  z-index:10;
}

.header{ font-size:56px; font-weight:600; line-height:1; }
.subHeader{ font-size:15px; color:var(--muted); margin-top:6px; }

.grid{
  display:grid;
  grid-template-columns:2.1fr 1fr;
  gap:14px;
  margin-top:16px;
}

.panel{
  background:var(--panel);
  border-radius:14px;
  padding:14px;
}

.shiftBanner{
  font-size:15px;
  padding:6px 10px;
  border-radius:10px;
  display:inline-block;
  margin-bottom:8px;
}
.shift-OFF{ background:#2a2f3a; }
.shift-SHIFT{ background:#7a2e2e; }
.shift-TEACHING{ background:#2e4e7a; }

.nowNext{
  font-size:14px;
  margin-bottom:8px;
  color:#c7d0df;
}

/* calendar grid */
.calendarGrid{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:10px 12px;
  border-top:1px solid var(--divider);
  padding-top:10px;
}

.dayBlock{ min-width:0; }
.dayTitle{
  font-weight:600;
  color:var(--accent);
  font-size:13px;
  margin-bottom:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.eventRow{
  display:flex;
  align-items:baseline;
  font-size:13px;
  line-height:1.2;
  margin-bottom:2px;
}

.timeCol{
  width:60px;
  color:var(--muted);
  font-variant-numeric:tabular-nums;
  white-space:nowrap; /* keep time + AM/PM together */
}

.eventTitle{
  flex:1;
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.big{ font-size:38px; font-weight:600; }
.small{ font-size:12px; color:#8b94a3; margin-top:3px; }

.tubTemp{ font-size:36px; font-weight:600; }
.statGrid{ margin-top:6px; font-size:12px; color:var(--muted); }

@media (max-width:980px){
  .grid{ grid-template-columns:1fr; }
  .header{ font-size:48px; }
  .calendarGrid{ grid-template-columns:repeat(2, 1fr); }
}
</style>
</head>

<body>
<div class="header" id="clock">--:--</div>
<div class="subHeader" id="countdown">Loading…</div>

<div class="grid">

  <div class="panel">
    <div id="shift"></div>
    <div class="nowNext" id="nowNext"></div>
    <div id="calendar">Loading…</div>
  </div>

  <div>
    <div class="panel">
      <div id="weather">Loading…</div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div id="tub">Loading…</div>
    </div>
  </div>

</div>

<script>
/* ======================================================
   CLOCK
====================================================== */
function tick(){
  clock.textContent =
    new Date().toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
}
tick();
setInterval(tick,1000);

/* ======================================================
   LOAD DATA
====================================================== */
const api =
"https://script.google.com/macros/s/AKfycbydfy3idgYUJXPNfHZ54LKWKkkljHYEr8ydMZKvaIrNANT_ccGfw_LgXVmSVckk4E-k6Q/exec";

function loadData(){
  fetch(api)
  .then(r=>r.json())
  .then(data=>{
    renderShift(data.shift_state);
    renderNowNext(data);
    renderCalendar(data.events);
    renderWeather(data.weather);
    renderTub(data);
    renderCountdown(data.next_event);
  });
}
loadData();
setInterval(loadData,600000);

/* ======================================================
   SHIFT STATE
====================================================== */
function renderShift(state){
  shift.innerHTML =
    "<div class='shiftBanner shift-"+state+"'>"+
    state+
    "</div>";
}

/* ======================================================
   NOW / NEXT
====================================================== */
function renderNowNext(data){
  let html="";
  if(data.now_event){
    html+="Now: "+data.now_event.title+"<br>";
  }
  if(data.next_event){
    const d=new Date(data.next_event.start);
    html+="Next: "+
      formatTime(d)+
      " "+data.next_event.title;
  }
  nowNext.innerHTML=html;
}

/* ======================================================
   CALENDAR (3x2 day grid + cache)
====================================================== */
let lastEventsKey = "";
let lastCalendarHTML = "";

function renderCalendar(events){
  if(!events.length){
    if(lastEventsKey !== "EMPTY"){
      calendar.textContent="No events";
      lastEventsKey="EMPTY";
      lastCalendarHTML="";
    }
    return;
  }

  const key = events.map(e=>e.start+"|"+e.title).join(";");
  if(key === lastEventsKey && lastCalendarHTML){
    return; // skip re-render
  }

  const grouped = {};
  for(let i=0;i<events.length;i++){
    const d=new Date(events[i].start);
    const k=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
    (grouped[k]||(grouped[k]=[])).push(events[i]);
  }

  const keys=Object.keys(grouped).sort((a,b)=>{
    return new Date(a)-new Date(b);
  }).slice(0,6);

  let html="<div class='calendarGrid'>";
  for(let i=0;i<keys.length;i++){
    const dayKey=keys[i];
    const dayDate=new Date(dayKey);
    html+="<div class='dayBlock'>";
    html+="<div class='dayTitle'>"+dayDate.toDateString()+"</div>";

    const dayEvents=grouped[dayKey];
    for(let j=0;j<dayEvents.length;j++){
      const d=new Date(dayEvents[j].start);
      html+="<div class='eventRow'>";
      html+="<div class='timeCol'>"+formatTime(d)+"</div>";
      html+="<div class='eventTitle'>"+dayEvents[j].title+"</div>";
      html+="</div>";
    }
    html+="</div>";
  }
  html+="</div>";

  lastEventsKey = key;
  lastCalendarHTML = html;
  calendar.innerHTML = html;
}

/* ======================================================
   WEATHER
====================================================== */
function renderWeather(w){
  weather.innerHTML=
    "<div class='big'>"+w.current+"°C</div>"+
    "<div class='small'>Hi "+w.high+
    "°  Low "+w.low+"°</div>";
}

/* ======================================================
   TUB
====================================================== */
function trend(c,a){
  const d=c-a;
  if(Math.abs(d)<0.2) return "→";
  return d>0?"↑":"↓";
}

function renderTub(d){
  tub.innerHTML=
    "<div class='tubTemp'>"+
      d.current+"° "+
      trend(d.current,d.avg)+
    "</div>"+
    "<div class='statGrid'>"+
      "Min "+d.min+"°  "+
      "Max "+d.max+"°  "+
      "Avg "+d.avg+"°"+
    "</div>"+
    "<div class='small'>"+
      "Updated "+
      formatTime(new Date(d.as_of))+
    "</div>";
}

/* ======================================================
   COUNTDOWN
====================================================== */
function renderCountdown(next){
  if(!next){
    countdown.textContent="No upcoming events";
    return;
  }
  const nextDate=new Date(next.start);
  function update(){
    const diff=nextDate-new Date();
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    countdown.textContent=
      "Next event in "+h+"h "+m+"m";
  }
  update();
  setInterval(update,60000);
}

/* ======================================================
   TIME FORMAT (keep AM on same line)
====================================================== */
function formatTime(d){
  return d.toLocaleTimeString([],{
    hour:"numeric",minute:"2-digit"
  }).replace(" AM","\u202FAM").replace(" PM","\u202FPM");
}

/* ======================================================
   AUTO DIM (time of day)
====================================================== */
function setAutoDim(){
  const h=new Date().getHours();
  let dim=0;
  if(h>=20 || h<6){
    const night = h>=20 ? h-20 : h+4; // 0..9
    dim = Math.min(0.24, night*0.03);
  }
  document.documentElement.style.setProperty("--dim", dim.toFixed(2));
}
setAutoDim();
setInterval(setAutoDim,60000);
</script>

</body>
</html>
