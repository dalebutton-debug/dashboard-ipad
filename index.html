<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>iPad Dashboard</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  margin: 0;
  padding: 20px;
}

.panel {
  background: #1c1c1c;
  padding: 16px;
  margin-bottom: 20px;
  border-radius: 12px;
}

h2 {
  margin-top: 0;
}

.event {
  margin-bottom: 12px;
}

.tempBig {
  font-size: 36px;
  font-weight: bold;
}

.trend {
  font-size: 18px;
  color: #aaa;
}

.small {
  font-size: 12px;
  color: #aaa;
}
</style>
</head>

<body>

<!-- CLOCK -->
<div class="panel">
  <h2 id="clock">--:--</h2>
</div>

<!-- CALENDAR -->
<div class="panel">
  <h2>Upcoming Events</h2>
  <div id="events">Loading…</div>
</div>

<!-- HOT TUB -->
<div class="panel">
  <h2>Hot Tub</h2>
  <div id="tub">Loading…</div>
</div>

<script>

//
// ---------- CLOCK ----------
//

function updateClock() {
  var now = new Date();
  document.getElementById("clock").innerHTML =
    now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

updateClock();
setInterval(updateClock, 1000);


//
// ---------- GOOGLE CALENDAR ----------
//

var feed =
"https://calendar.google.com/calendar/ical/8fb34a1e4e02726e39bbe84dd616bdd4ef1b910b66fc928f6484795e95d257eb%40group.calendar.google.com/public/basic.ics";

fetch(feed)
.then(function(r){ return r.text(); })
.then(function(text){

  var events = text.split("BEGIN:VEVENT").slice(1);
  var all = [];

  events.forEach(function(e){

    var title = /SUMMARY:(.*)/.exec(e);
    var date  = /DTSTART.*:(.*)/.exec(e);

    if (!title || !date) return;

    var raw = date[1].trim();

    var y = raw.substring(0,4);
    var m = raw.substring(4,6);
    var d = raw.substring(6,8);
    var h = raw.substring(9,11) || "00";
    var min = raw.substring(11,13) || "00";

    var obj = new Date(y, m-1, d, h, min);

    if (obj > new Date()) {
      all.push({
        title: title[1],
        date: obj
      });
    }

  });

  all.sort(function(a,b){
    return a.date - b.date;
  });

  var html = "";

  all.slice(0,15).forEach(function(e){

    html += "<div class='event'>";
    html += "<b>" + e.title + "</b><br>";
    html += e.date.toLocaleString();
    html += "</div>";

  });

  document.getElementById("events").innerHTML = html;

});


//
// ---------- HOT TUB ----------
//

var tubURL =
"https://script.google.com/macros/s/AKfycbydfy3idgYUJXPNfHZ54LKWKkkljHYEr8ydMZKvaIrNANT_ccGfw_LgXVmSVckk4E-k6Q/exec";

function fmt1(x) {
  var n = Number(x);
  if (!isFinite(n)) return "-";
  return n.toFixed(1);
}

function trendSymbol(c,a) {
  var d = c - a;
  if (Math.abs(d) < 0.2) return "→";
  return d > 0 ? "↑" : "↓";
}

function lastTime(s) {
  var d = new Date(s);
  if (isNaN(d)) return "--:--";
  return d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
}

function loadTub() {

  fetch(tubURL)
  .then(function(r){ return r.json(); })
  .then(function(data){

    var html = "";

    html += "<div class='tempBig'>";
    html += fmt1(data.current) + "° ";
    html += "<span class='trend'>";
    html += trendSymbol(data.current,data.avg);
    html += "</span></div>";

    html += "<div style='margin-top:10px'>";
    html += "<b>MIN:</b> " + fmt1(data.min) + "°<br>";
    html += "<b>MAX:</b> " + fmt1(data.max) + "°<br>";
    html += "<b>AVG:</b> " + fmt1(data.avg) + "°";
    html += "</div>";

    html += "<div class='small' style='margin-top:10px'>";
    html += "Updated " + lastTime(data.as_of);
    html += "</div>";

    document.getElementById("tub").innerHTML = html;

  });
}

loadTub();


//
// ---------- AUTO REFRESH ----------
//

setInterval(function(){
  location.reload();
}, 600000); // 10 minutes

</script>

</body>
</html>
