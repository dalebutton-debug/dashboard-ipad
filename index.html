<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Home Dashboard</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#131821;
  --text:#e6e9ef;
  --muted:#9aa6b5;
  --accent:#7fa2ff;
  --divider:#1e2530;
  --dim:0;
  --s:1.5; /* +20% from last version */
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:calc(18px * var(--s));
  font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:#000;
  opacity:var(--dim);
  pointer-events:none;
  transition:opacity 1s linear;
  z-index:10;
}

.header{
  font-size:calc(56px * var(--s));
  font-weight:600;
  line-height:1;
}
.subHeader{
  font-size:calc(15px * var(--s));
  color:var(--muted);
  margin-top:calc(6px * var(--s));
}

.statusRow{
  display:flex;
  align-items:center;
  gap:calc(10px * var(--s));
  margin-top:calc(6px * var(--s));
  font-size:calc(12px * var(--s));
  color:var(--muted);
}

.dot{
  width:calc(10px * var(--s));
  height:calc(10px * var(--s));
  border-radius:50%;
  background:#6b7c93;
  display:inline-block;
}

.grid{
  display:grid;
  grid-template-columns:2.1fr 1fr;
  gap:calc(14px * var(--s));
  margin-top:calc(16px * var(--s));
}

.panel{
  background:var(--panel);
  border-radius:calc(14px * var(--s));
  padding:calc(14px * var(--s));
}

.shiftBanner{
  font-size:calc(15px * var(--s));
  padding:calc(6px * var(--s)) calc(10px * var(--s));
  border-radius:calc(10px * var(--s));
  display:inline-block;
  margin-bottom:calc(8px * var(--s));
}
.shift-OFF{ background:#2a2f3a; }
.shift-SHIFT{ background:#7a2e2e; }
.shift-TEACHING{ background:#2e4e7a; }

.nowNext{
  font-size:calc(14px * var(--s));
  margin-bottom:calc(8px * var(--s));
  color:#c7d0df;
}

/* calendar grid */
.calendarGrid{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:calc(10px * var(--s)) calc(12px * var(--s));
  border-top:1px solid var(--divider);
  padding-top:calc(10px * var(--s));
}

.dayBlock{ min-width:0; }
.dayTitle{
  font-weight:600;
  color:var(--accent);
  font-size:calc(14px * var(--s));
  margin-bottom:calc(5px * var(--s));
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.eventRow{
  display:flex;
  align-items:baseline;
  font-size:calc(15px * var(--s));
  line-height:1.25;
  margin-bottom:calc(3px * var(--s));
}

.timeCol{
  width:calc(64px * var(--s));
  color:var(--muted);
  font-variant-numeric:tabular-nums;
  white-space:nowrap;
}

.eventTitle{
  flex:1;
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.big{ font-size:calc(38px * var(--s)); font-weight:600; }
.small{ font-size:calc(12px * var(--s)); color:#8b94a3; margin-top:calc(3px * var(--s)); }

.tubTemp{ font-size:calc(36px * var(--s)); font-weight:600; }
.statGrid{ margin-top:calc(6px * var(--s)); font-size:calc(12px * var(--s)); color:var(--muted); }

.toggleRow{
  margin-top:calc(6px * var(--s));
  font-size:calc(12px * var(--s));
  color:var(--muted);
}
.toggleRow input{ transform:scale(1.2); margin-right:calc(6px * var(--s)); }

@media (max-width:980px){
  .grid{ grid-template-columns:1fr; }
  .header{ font-size:calc(48px * var(--s)); }
  .calendarGrid{ grid-template-columns:repeat(2, 1fr); }
}
</style>
</head>

<body>
<div class="header" id="clock">--:--</div>
<div class="subHeader" id="countdown">Loading…</div>

<div class="statusRow">
  <span class="dot" id="netDot"></span>
  <span id="lastUpdated">Last updated: --</span>
</div>

<div class="grid">

  <div class="panel">
    <div id="shift"></div>
    <div class="nowNext" id="nowNext"></div>
    <div class="toggleRow">
      <label><input type="checkbox" id="compactToggle">Show today + tomorrow only</label>
    </div>
    <div id="calendar">Loading…</div>
  </div>

  <div>
    <div class="panel">
      <div id="weather">Loading…</div>
    </div>

    <div class="panel" style="margin-top:calc(14px * var(--s));">
      <div id="tub">Loading…</div>
    </div>
  </div>

</div>

<script>
/* ======================================================
   CLOCK
====================================================== */
function tick(){
  clock.textContent =
    new Date().toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
}
tick();
setInterval(tick,1000);

/* ======================================================
   LOAD DATA
====================================================== */
const api =
"https://script.google.com/macros/s/AKfycbydfy3idgYUJXPNfHZ54LKWKkkljHYEr8ydMZKvaIrNANT_ccGfw_LgXVmSVckk4E-k6Q/exec";

let fetchInterval = 600000; // 10 min default
let fetchTimer = null;

function scheduleFetch(){
  if(fetchTimer) clearInterval(fetchTimer);
  fetchTimer = setInterval(loadData, fetchInterval);
}

function loadData(){
  fetch(api)
  .then(r=>r.json())
  .then(data=>{
    renderShift(data.shift_state);
    renderNowNext(data);
    renderCalendar(data.events);
    renderWeather(data.weather);
    renderTub(data);
    renderCountdown(data.next_event);
    renderStatus(data.api_updated);
  });
}
loadData();
scheduleFetch();

/* ======================================================
   SHIFT STATE
====================================================== */
function renderShift(state){
  shift.innerHTML =
    "<div class='shiftBanner shift-"+state+"'>"+
    state+
    "</div>";
}

/* ======================================================
   NOW / NEXT (cached)
====================================================== */
let lastNowNextKey="";

function renderNowNext(data){
  const nowTitle = data.now_event ? data.now_event.title : "";
  const nextTitle = data.next_event ? data.next_event.title : "";
  const nextTime = data.next_event ? data.next_event.start : "";
  const key = nowTitle+"|"+nextTitle+"|"+nextTime;

  if(key === lastNowNextKey) return;

  let html="";
  if(data.now_event){
    html+="Now: "+data.now_event.title+"<br>";
  }
  if(data.next_event){
    const d=new Date(data.next_event.start);
    html+="Next: "+
      formatTime(d)+
      " "+data.next_event.title;
  }
  nowNext.innerHTML=html;
  lastNowNextKey=key;
}

/* ======================================================
   CALENDAR (3x2 day grid + cache)
====================================================== */
let lastEventsKey = "";
let lastCalendarHTML = "";
let showCompact = false;

compactToggle.addEventListener("change", ()=>{
  showCompact = compactToggle.checked;
  lastEventsKey = ""; // force rerender
  renderCalendar(lastEventsData);
});

let lastEventsData = [];

function renderCalendar(events){
  lastEventsData = events;

  if(!events.length){
    if(lastEventsKey !== "EMPTY"){
      calendar.textContent="No events";
      lastEventsKey="EMPTY";
      lastCalendarHTML="";
    }
    return;
  }

  const key = events.map(e=>e.start+"|"+e.title).join(";") + "|" + (showCompact ? "C" : "F");
  if(key === lastEventsKey && lastCalendarHTML){
    return;
  }

  const grouped = {};
  for(let i=0;i<events.length;i++){
    const d=new Date(events[i].start);
    const y=d.getFullYear();
    const m=d.getMonth()+1;
    const day=d.getDate();
    const k=y*10000 + m*100 + day;
    if(!grouped[k]){
      grouped[k]={
        date:new Date(y, m-1, day),
        events:[]
      };
    }
    grouped[k].events.push(events[i]);
  }

  const keys=Object.keys(grouped).sort((a,b)=>a-b);
  const sliced = showCompact ? keys.slice(0,2) : keys.slice(0,6);

  let html="<div class='calendarGrid'>";
  for(let i=0;i<sliced.length;i++){
    const block=grouped[sliced[i]];
    html+="<div class='dayBlock'>";
    html+="<div class='dayTitle'>"+block.date.toDateString()+"</div>";

    const dayEvents=block.events;
    for(let j=0;j<dayEvents.length;j++){
      const d=new Date(dayEvents[j].start);
      html+="<div class='eventRow'>";
      html+="<div class='timeCol'>"+formatTime(d)+"</div>";
      html+="<div class='eventTitle'>"+dayEvents[j].title+"</div>";
      html+="</div>";
    }
    html+="</div>";
  }
  html+="</div>";

  lastEventsKey = key;
  lastCalendarHTML = html;
  calendar.innerHTML = html;
}

/* ======================================================
   WEATHER (cached)
====================================================== */
let lastWeatherKey="";

function renderWeather(w){
  const key = w.current+"|"+w.high+"|"+w.low+"|"+w.feels_like+"|"+w.wind+"|"+w.precip;
  if(key === lastWeatherKey) return;

  weather.innerHTML=
    "<div class='big'>"+w.current+"°C</div>"+
    "<div class='small'>Hi "+w.high+
    "°  Low "+w.low+"°</div>"+
    "<div class='small'>Feels "+w.feels_like+
    "°  Wind "+w.wind+" km/h</div>"+
    "<div class='small'>Precip "+w.precip+"%</div>";

  lastWeatherKey=key;
}

/* ======================================================
   TUB (cached, avg 1 decimal)
====================================================== */
let lastTubKey="";

function renderTub(d){
  const key = d.current+"|"+d.min+"|"+d.max+"|"+d.avg+"|"+d.as_of;
  if(key === lastTubKey) return;

  tub.innerHTML=
    "<div class='tubTemp'>"+
      d.current+"° "+
      trend(d.current,d.avg)+
    "</div>"+
    "<div class='statGrid'>"+
      "Min "+d.min+"°  "+
      "Max "+d.max+"°  "+
      "Avg "+Number(d.avg).toFixed(1)+"°"+
    "</div>"+
    "<div class='small'>"+
      "Updated "+
      formatTime(new Date(d.as_of))+
    "</div>";

  lastTubKey=key;
}

/* ======================================================
   COUNTDOWN
====================================================== */
function renderCountdown(next){
  if(!next){
    countdown.textContent="No upcoming events";
    return;
  }
  const nextDate=new Date(next.start);
  function update(){
    const diff=nextDate-new Date();
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    countdown.textContent=
      "Next event in "+h+"h "+m+"m";
  }
  update();
  setInterval(update,60000);
}

/* ======================================================
   STATUS + CONNECTIVITY
====================================================== */
function renderStatus(apiUpdated){
  const d = new Date(apiUpdated);
  lastUpdated.textContent = "Last updated: " + formatTime(d);

  const age = (new Date() - d) / 60000; // minutes
  if(age < 20){
    netDot.style.background = "#4cd964"; // green
  }else if(age < 60){
    netDot.style.background = "#ffcc00"; // yellow
  }else{
    netDot.style.background = "#ff3b30"; // red
  }
}

/* ======================================================
   TIME FORMAT (keep AM on same line)
====================================================== */
function formatTime(d){
  return d.toLocaleTimeString([],{
    hour:"numeric",minute:"2-digit"
  }).replace(" AM","\u202FAM").replace(" PM","\u202FPM");
}

/* ======================================================
   AUTO DIM + QUIET HOURS
====================================================== */
function setAutoDim(){
  const h=new Date().getHours();
  let dim=0;
  if(h>=20 || h<6){
    const night = h>=20 ? h-20 : h+4;
    dim = Math.min(0.30, night*0.035);
    fetchInterval = 1800000; // 30 min at night
  }else{
    fetchInterval = 600000;  // 10 min daytime
  }
  document.documentElement.style.setProperty("--dim", dim.toFixed(2));
  scheduleFetch();
}
setAutoDim();
setInterval(setAutoDim,60000);

/* ======================================================
   TREND
====================================================== */
function trend(c,a){
  const d=c-a;
  if(Math.abs(d)<0.2) return "→";
  return d>0?"↑":"↓";
}
</script>

</body>
</html>
