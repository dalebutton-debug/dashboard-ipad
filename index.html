<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Home Dashboard</title>

<style>

body {
  margin: 0;
  padding: 24px;
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  background: #0c0e12;
  color: #e8eaed;
}

.header {
  font-size: 56px;
  font-weight: 600;
  letter-spacing: 1px;
  margin-bottom: 24px;
}

.grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-gap: 24px;
}

.panel {
  background: #161a22;
  border-radius: 18px;
  padding: 20px;
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
}

.panel h2 {
  margin-top: 0;
  font-size: 20px;
  letter-spacing: .6px;
  color: #9fb3ff;
}

.dayBlock {
  margin-bottom: 18px;
}

.dayTitle {
  font-size: 18px;
  font-weight: 600;
  color: #7fa2ff;
  margin-bottom: 6px;
}

.event {
  font-size: 16px;
  margin-bottom: 4px;
  color: #e6e6e6;
}

.time {
  color: #aab4c5;
}

.tempBig {
  font-size: 52px;
  font-weight: 600;
}

.statRow {
  margin-top: 10px;
  font-size: 16px;
  color: #c6ccd6;
}

.small {
  margin-top: 10px;
  font-size: 13px;
  color: #9aa3b2;
}

.weatherTemp {
  font-size: 48px;
  font-weight: 600;
}

</style>
</head>

<body>

<div class="header" id="clock">--:--</div>

<div class="grid">

  <!-- CALENDAR -->
  <div class="panel">
    <h2>Next 5 Days</h2>
    <div id="calendar">Loading…</div>
  </div>

  <div>

    <!-- WEATHER -->
    <div class="panel">
      <h2>Today</h2>
      <div id="weather">Loading…</div>
    </div>

    <!-- HOT TUB -->
    <div class="panel" style="margin-top:24px;">
      <h2>Hot Tub</h2>
      <div id="tub">Loading…</div>
    </div>

  </div>

</div>

<script>

//
// ---------- CLOCK ----------
//

function updateClock(){
  var now = new Date();
  document.getElementById("clock").innerHTML =
    now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

updateClock();
setInterval(updateClock,1000);


//
// ---------- DATA ENDPOINT ----------
//

var api =
"https://script.google.com/macros/s/AKfycbydfy3idgYUJXPNfHZ54LKWKkkljHYEr8ydMZKvaIrNANT_ccGfw_LgXVmSVckk4E-k6Q/exec";

fetch(api)
.then(function(r){ return r.json(); })
.then(function(data){

  renderCalendar(data.events);
  renderTub(data);

});


//
// ---------- CALENDAR ----------
//

function renderCalendar(events){

  if(!events) return;

  var today = new Date();
  var end = new Date();
  end.setDate(today.getDate()+5);

  var filtered = events.filter(function(e){
    var d = new Date(e.start);
    return d >= today && d <= end;
  });

  filtered.sort(function(a,b){
    return new Date(a.start) - new Date(b.start);
  });

  var grouped = {};

  filtered.forEach(function(e){

    var d = new Date(e.start);
    var key = d.toDateString();

    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(e);

  });

  var html="";

  Object.keys(grouped).forEach(function(day){

    html += "<div class='dayBlock'>";
    html += "<div class='dayTitle'>"+day+"</div>";

    grouped[day].forEach(function(e){

      var d = new Date(e.start);

      html += "<div class='event'>";
      html += "<span class='time'>";
      html += d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      html += "</span> — "+e.title;
      html += "</div>";

    });

    html += "</div>";

  });

  document.getElementById("calendar").innerHTML = html;

}


//
// ---------- HOT TUB ----------
//

function fmt1(x){
  var n = Number(x);
  if(!isFinite(n)) return "-";
  return n.toFixed(1);
}

function trendSymbol(c,a){
  var d=c-a;
  if(Math.abs(d)<0.2) return "→";
  return d>0 ? "↑":"↓";
}

function renderTub(d){

  var html="";

  html+="<div class='tempBig'>";
  html+=fmt1(d.current)+"° ";
  html+="<span style='font-size:22px;color:#9aa3b2'>";
  html+=trendSymbol(d.current,d.avg);
  html+="</span></div>";

  html+="<div class='statRow'>";
  html+="Min "+fmt1(d.min)+"°<br>";
  html+="Max "+fmt1(d.max)+"°<br>";
  html+="Avg "+fmt1(d.avg)+"°";
  html+="</div>";

  html+="<div class='small'>";
  html+="Updated "+
    new Date(d.as_of).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  html+="</div>";

  document.getElementById("tub").innerHTML=html;

}


//
// ---------- WEATHER ----------
//

var lat = 43.945;
var lon = -78.895;

fetch(
"https://api.open-meteo.com/v1/forecast?latitude="+lat+
"&longitude="+lon+
"&current_weather=true"
)
.then(function(r){ return r.json(); })
.then(function(data){

  var w=data.current_weather;

  var html="";

  html+="<div class='weatherTemp'>"+w.temperature+"°C</div>";
  html+="<div class='statRow'>";
  html+="Wind "+w.windspeed+" km/h";
  html+="</div>";

  html+="<div class='small'>";
  html+="Updated "+
    new Date(w.time).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  html+="</div>";

  document.getElementById("weather").innerHTML=html;

});


//
// ---------- AUTO REFRESH ----------
//

setInterval(function(){
  location.reload();
},600000);

</script>

</body>
</html>
