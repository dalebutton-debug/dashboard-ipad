<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dashboard</title>

<style>

body{
  margin:0;
  padding:22px;
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
  background:#0b0f14;
  color:#e6e9ef;
}

.header{
  font-size:64px;
  font-weight:600;
}

.countdown{
  font-size:18px;
  color:#9aa6b5;
  margin-top:4px;
}

.grid{
  display:grid;
  grid-template-columns:2.2fr 1fr;
  gap:18px;
  margin-top:20px;
}

.panel{
  background:#141922;
  border-radius:18px;
  padding:18px;
}

/* ---------- CALENDAR ---------- */

.dayBlock{
  margin-bottom:14px;
}

.dayTitle{
  font-weight:600;
  color:#7fa2ff;
  margin-bottom:6px;
}

.eventRow{
  display:flex;
  margin-bottom:4px;
}

.timeCol{
  width:64px;
  color:#9aa6b5;
}

.eventTitle{
  flex:1;
}

/* ---------- WEATHER / TUB ---------- */

.big{
  font-size:46px;
  font-weight:600;
}

.small{
  font-size:13px;
  color:#8b94a3;
}

</style>
</head>

<body>

<div class="header" id="clock">--:--</div>
<div class="countdown" id="countdown">Loading…</div>

<div class="grid">

  <div class="panel">
    <div id="calendar">Loading…</div>
  </div>

  <div>

    <div class="panel">
      <div id="weather">Loading…</div>
    </div>

    <div class="panel" style="margin-top:18px;">
      <div id="tub">Loading…</div>
    </div>

  </div>

</div>

<script>

/* ---------- CLOCK ---------- */

function tick(){
  clock.innerHTML =
    new Date().toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
}
tick();
setInterval(tick,1000);


/* ---------- LOAD DATA ---------- */

const api =
"https://script.google.com/macros/s/AKfycbydfy3idgYUJXPNfHZ54LKWKkkljHYEr8ydMZKvaIrNANT_ccGfw_LgXVmSVckk4E-k6Q/exec";

function loadData(){

  fetch(api)
  .then(r=>r.json())
  .then(data=>{

    requestAnimation hookupFrame(()=>{
      renderCalendar(data.events);
    });

    renderTub(data);
    renderCountdown(data.events);

  });

}

loadData();
setInterval(loadData,600000);


/* ---------- CALENDAR ---------- */

function renderCalendar(events){

  if(!events.length){
    calendar.innerHTML="No events";
    return;
  }

  const grouped={};

  events.forEach(e=>{
    const d=new Date(e.start);
    const key=d.toDateString();
    if(!grouped[key]) grouped[key]=[];
    grouped[key].push(e);
  });

  let html="";

  Object.keys(grouped).forEach(day=>{

    html+="<div class='dayBlock'>";
    html+="<div class='dayTitle'>"+day+"</div>";

    grouped[day].forEach(e=>{

      const d=new Date(e.start);

      html+="<div class='eventRow'>";
      html+="<div class='timeCol'>"+
        d.toLocaleTimeString([],{
          hour:"2-digit",minute:"2-digit"
        })+
      "</div>";
      html+="<div class='eventTitle'>"+e.title+"</div>";
      html+="</div>";

    });

    html+="</div>";

  });

  calendar.innerHTML=html;

}


/* ---------- COUNTDOWN ---------- */

function renderCountdown(events){

  const now=new Date();
  let next=null;

  events.forEach(e=>{
    const d=new Date(e.start);
    if(d>now && (!next||d<next)) next=d;
  });

  if(!next){
    countdown.innerHTML="No upcoming events";
    return;
  }

  function update(){
    const diff=next-new Date();
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    countdown.innerHTML=
      "Next event in "+h+"h "+m+"m";
  }

  update();
  setInterval(update,60000);

}


/* ---------- TUB ---------- */

function renderTub(d){

  tub.innerHTML=
    "<div class='big'>"+d.current+"°</div>"+
    "<div class='small'>Avg "+d.avg+"°</div>";

}


/* ---------- WEATHER ---------- */

fetch(
"https://api.open-meteo.com/v1/forecast?latitude=43.945&longitude=-78.895&current_weather=true"
)
.then(r=>r.json())
.then(data=>{

  const w=data.current_weather;

  weather.innerHTML=
    "<div class='big'>"+w.temperature+"°C</div>"+
    "<div class='small'>Wind "+w.windspeed+" km/h</div>";

});

</script>

</body>
</html>
